---
title: 'BST 260: Final Project'
output: html_document
---

Project Background

Overview and Motivation


Tuberculosis (TB) kills more people per year globally than any other infectious disease. TB infection presents as a spectrum of disease states ranging from asymptomatic latent tuberculosis infection (LTBI), to the more clinically dangerous, active tuberculosis disease (ATB). Currently, the immune factors that determine whether an individual will develop LTBI or ATB upon TB infection remain undefined. Furthermore, while current TB diagnostics can accurately distinguish TB-infected vs. TB-uninfected individuals, current immune-based diagnostics are unable to distinguish LTBI from ATB, complicating comprehensive TB diagnosis, and thus treatment. Thus, defining the immune characteristics that distinguish the more protected LTBI state from the the more dangerous state of ATB may further our understanding of the drivers of protective immunity to TB, as well as provide the basis for a novel immune-based diagnostic to resolve the two infection states. 



Related Work


To date, a large proportion of TB immunology work has focused on T cell immunity. In contrast, exploration into antibodies as a potential vaccine and diagnostic axis have been limited. Thus, my gradute work has focused on exploiting the antibody respose for therapeutic and diagnostic purposes. 



Initial Questions


Do antibody profiles distinguish ATB from LTBI individuals?
Which features of the antibody responses are distinctive of each infection state?



Dataset


These samples were derived from a cohort of LTBI and ATB individuals from Cape Town, South Africa. The resulting data were generated by profiling the antibody responses present in the plasma of each individual. Measurements include antibody levels to different TB antigens, as well as measurements of antibody glycosylation and functionality. This framework for antibody profiling is termed Systems Serology. Furthermore, the measurements were experimentally determined by Lenette Lu in the laboratory of Galit Alter, and the data have been previously published using different methods of data analysis (Lu et al. Cell 2016).



Data analysis

Data Pre-processing


These data were cleaned-up slightly prior to analysis. Most importantly, columns (or antibody features) with missing data were removed. Although imputing data represented another option, the relatively small number of individuals from which the data were collected made imputation a less attractive option. Additionally the data were z-scored prior to analysis such that each feature was treated equally by the models I employed. Because all the the anitbody measurements do not necessarily have the same units, this is a critical step.

```{r}
##########################
### Data Preprocessing ###
##########################
TB_data <- read.csv("LL_data.csv")
TB_data_clean <- TB_data[1:20, ]
colnames(TB_data_clean)[1] <- "Group"

#Remove columns with missing data
TB_data_clean <- TB_data_clean[ , colSums(is.na(TB_data_clean)) == 0]

#Z-score data
TB_data_clean[ , 4:82] <- scale(TB_data_clean[4:82], center = TRUE, scale = TRUE)
```





Exploratory Analysis


To begin to explore the structure of my data, I began with a few unsupervised approaches including hierarchical clustering and PCA. Ideally, unsupervised analyses would allow nice separation between LTBI and ATB individuals, such that supervised analysis would not need to be performed on a dataset derived from such a small number of individuals. 
Beginning with my hierarchical clustering analysis, I tried two different linkage measures, complete and average. 

```{r}
##########################
# Hierarchichal clustering
##########################
library(dendextend)
dist_TB_data <- dist(TB_data_clean)

### Average linkage
hc_TB_data_avg <- hclust(dist_TB_data, method = "average")
plot(hc_TB_data_avg)
TB_color_avg <- c("cornflowerblue", "darkmagenta", "darkmagenta", "darkmagenta", "cornflowerblue", "cornflowerblue", "darkmagenta", "darkmagenta", "darkmagenta", "darkmagenta", 
              "darkmagenta", "cornflowerblue", "darkmagenta", "cornflowerblue", "cornflowerblue", "darkmagenta", "cornflowerblue", "cornflowerblue", "cornflowerblue", "cornflowerblue")
colored_bars(colors = TB_color_avg, rowLabels = "Group")
legend("topright", legend = c("LTBI", "ATB"), pch = c(15, 15), col = c("cornflowerblue", "darkmagenta"), pt.cex = 2)

### Complete linkage
hc_TB_data_complete <- hclust(dist_TB_data, method = "complete")
plot(hc_TB_data_complete)
TB_color_complete <- c("darkmagenta", "darkmagenta", "darkmagenta", "darkmagenta", "cornflowerblue", "cornflowerblue", "darkmagenta", "darkmagenta", "darkmagenta", "cornflowerblue",
              "darkmagenta",  "cornflowerblue", "darkmagenta", "cornflowerblue", "cornflowerblue", "darkmagenta", "cornflowerblue", "cornflowerblue", "cornflowerblue", "cornflowerblue")
colored_bars(colors = TB_color_complete, rowLabels = "Group")
legend("topright", legend = c("LTBI", "ATB"), pch = c(15, 15), col = c("cornflowerblue", "darkmagenta"), pt.cex = 2)
```

As seen in in the two dendrograms, neither of the hierarchical clustering approaches provided great separation from LTBI and ATB individuals. 


Following hierarchical clustering analysis, I additionally tried some PCA analysis. This was again, in hope that this unsupervised analysis would allow the separation of the two groups. 

```{r}
#####
# PCA
#####
library(ggplot2)
library(ggfortify)
library(dplyr)

### PCA w/ all data 
pca_TB_data <- prcomp(~., data = TB_data_clean[ , 4:82])
autoplot(pca_TB_data, data = TB_data_clean, colour = "Group", size = 5) + scale_color_manual(values=c("darkmagenta", "cornflowerblue")) + theme_linedraw() + ggtitle("Principal Component Analysis") 
```

Interestingly, LTBI and ATB individuals actually did separate nicely via PCA. Specifically, the two groups seemed to split very nicely on PC1. Thus, I performed a bit of follow-up analysis from this exciting PCA result to interrogate which antibody features largely contributed to separation on PC1. Specifically, I looked at the antibody features that correlated mostr strongly with PC1, then graphed each of these values separately for LTBI and ATB individuals. Given the LTBI group's higher PC1 values, I would expect that the features that strongly positively correlate with PC1 will be higher in LTBI individuals compared to ATB individuals.

```{r}
########################
# PCA Follow-up Analysis
########################
### Analysis of PC1 correlates
pcs <- pca_TB_data$x
pc1 <- unname(c(pcs[, 1]))

#Calculate correlation matrix between all features and PC1
pc1_features <- cbind(pc1, TB_data_clean[4:82])
corrMat = cor(pc1_features, method = "spearman", use = "complete.obs") 

#Pull out correlations with PC1
pc1_corr <- data.frame(corrMat[1, ])
colnames(pc1_corr)[1] <- "rho"

#Pull out top 10 features that positively correlate most strongly with PC1 (these should be higher in LTBI)
pc1_corr <- pc1_corr %>%
  mutate(feature = rownames(pc1_corr))
top_correlates <- pc1_corr %>% 
  top_n(11, rho) %>%
  .$feature
top_correlates

#Make a matrix containing just the aforementioned top 10 features 
small_matrix <- pc1_features %>%
  select(top_correlates) %>%
  mutate(Group = c(rep("LTBI", 10), rep("ATB", 10)))
small_matrix

#Prep data for graphs
dat <- stack(small_matrix)
LTBI_ATB <- c(rep("LTBI", 10), rep("ATB", 10))

dat <- dat %>%
  mutate(Group = rep(LTBI_ATB, 12)) %>%
  filter(ind != "pc1" & ind != "Group")
  
#Make box plots of each of the features that positively correlate most strongly with PC1, comparing ATB and LTBI individuals
top_correlates_graph <- dat %>%
  ggplot() +
  geom_boxplot(aes(x = as.factor(ind), y = as.numeric(values), fill = Group)) +
  theme_bw() + 
  ggtitle("Strongest Positive Correlates of PC1") +
  ylab("Z-score Feature") +
  xlab("") +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) +
  scale_fill_manual(breaks = c("ATB", "LTBI"), values=c("darkmagenta", "cornflowerblue"))
top_correlates_graph
```

This was indeed the case, as each of the top 10 positive correlates of PC1 were higher in the LTBI group compared to the ATB group as seen in the boxplot above. Interestingly, all of the top ten features pulled out in this analysis indicate increased galactosylation and sialylation of the antibodies in LTBI individuals compared to ATB individuals. This flavor of antibody glycosylation is considered anti-inflammatory, thus, this result suggests that compared to individuals with ATB, individuals with LTBI display an anti-inflammatory antibody glycosylation profile. 

Furthermore, the top 10 negative correlates of PC1 were additionally identified, and graphed. I would expect that the features that strongly negativey correlate with PC1 will be higher in ATB individuals compared to LTBI individuals.

```{r}
#Pull out top 10 features that negatively correlate most strongly with PC1 (these should be higher in ATB)
pc1_corr <- pc1_corr %>%
  mutate(sign_fipped_rho = (-1) * rho)
bottom_correlates <- pc1_corr %>% 
  top_n(10, sign_fipped_rho) %>%
  .$feature
bottom_correlates

#Make a matrix containing just the aforementioned top 10 features 
bottom_matrix <- pc1_features %>%
  select(bottom_correlates) %>%
  mutate(Group = c(rep("LTBI", 10), rep("ATB", 10)))
bottom_matrix

#Prep data for graphs
dat_bottom <- stack(bottom_matrix)

dat_bottom <- dat_bottom %>%
  mutate(Group = rep(LTBI_ATB, 11)) %>%
  filter(ind != "Group")

#Make box plots of each of the features that negatively correlate most strongly with PC1, comparing ATB and LTBI individuals
bottom_correlates_graph <- dat_bottom %>%
  ggplot() +
  geom_boxplot(aes(x = as.factor(ind), y = as.numeric(values), fill = Group)) +
  theme_bw() + 
  ggtitle("Strongest Negative Correlates of PC1") +
  ylab("Z-score Feature") +
  xlab("") +
  theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) +
  scale_fill_manual(breaks = c("ATB", "LTBI"), values=c("darkmagenta", "cornflowerblue"))
bottom_correlates_graph
```


These results hints at a few interesting trends. Firstly, pro-inflammatory antibody glycan structures are generally higher in ATB compared to LTBI individuals. These features include: wtotg0, wg0f, wg0fb, fctotG0, and fcg0f. Furthermore, ATB individuals display increased fucosylation (wtotfucose) as compared to LTBI individuals. This glycan profile is known to confer decreased antibody-dependent cellular cytotoxicity, thus this result suggests that antibodies from ATB individuals have decreased capacity to carry out this critical antibody effector function. Finally, the four antibody features on the far right are indicators of antibody levels to TB purified protein derivative (PPD). Thus, this result indicates that individuals with ATB exhibit increased antibody levels to PPD compared to LTBI individuals, which may not be surprising due to their increased bacterial burden. 



Logistic Regression 



Logistic regression analysis was additionally performed. Specifically, due to the high dimensional and co-linear structure of the data, individual logistic regression models were generated for each antibody feature, controlling for the parameters of age and gender. This allowed the calculation of p values and false discovery rate (fdr) corrected p values with respect to each antibody feature, and it's relation to TB disease state (LTBI vs. ATB). 

None of the antibody features were significant in the logistic regression analysis following fdr correction. This is likely in large part due to the relatively small sample size of the cohort (n = 20). However, for the purpose of hypothesis generation, the results are still intriguing and worth discussion. Specifically, the features determined to be significant by their uncorrected p value is dominated by antibody glycosylation features. This is clear looking at both the table and scatter plot. Individuals with LTBI have increased anti-inflammatory galactosyltion and sialylation patterns (fctotg2, fcg2s1f, wtotg2, wg2f, fctotsialic acid, fctotmonosialic, fcg2f, and wg2s1f), whereas individuals with ATB have increased pro-inflammatory agalactosylated structures (wtotg0 and wg0f). 

Thus, overall, this logistic regression analysis represents an orthogonal method to the PCA approach described above, and ultimately identified similar patterns in antibody profile differences between individuals with LTBI and ATB, lending further strength to the overall analysis. 

```{r}
###########################
### Logistic Regression ###
###########################
library(ggrepel)

#Initialize data frame that will hold the p values resulting from the individual logistic regression analyes
logit_pval_data <- setNames(data.frame(matrix(ncol = 3, nrow = 79)), c("feature", "p_val", "coeff"))

#Logistic regression model controlling for age and gender, looping through each of the antibody features as a third term, and thus calculating a p value for each
count <- 1
for (i in colnames(TB_data_clean[4:82])) {
  fit <- glm(as.factor(Group) ~ age + gender +  eval(parse(text = i)), data = TB_data_clean, family = "binomial")
  p_vals <- data.frame(coef(summary(fit))[,'Pr(>|z|)'])
  coeff <- data.frame(coef(summary(fit))[,'Estimate'])
  
  #Pull out p value from antibody feature tested
  feature_p_val <- p_vals[4, 1]
  
  feature_coeff <- coeff[4, 1]
  
  logit_pval_data$feature[count] <- i
  logit_pval_data$p_val[count] <- feature_p_val
  logit_pval_data$coeff[count] <- feature_coeff
  
  count <- count + 1
}

#FDR p-value adjustment to correct for multiple comparisons
logit_pval_data$fdr <- p.adjust(logit_pval_data$p_val, method = "fdr")
logit_pval_data$neglog <- -log2(logit_pval_data$p_val)

#Graph of -log2(p-value) vs. Log Odds (Coefficient Estimates)
logit_graph <- logit_pval_data %>%
  ggplot(aes(x = logit_pval_data$coeff, logit_pval_data$neglog, label = feature)) +
  geom_point() +
  ggtitle("Logistic Regression (controlling for age and gender)") +
  theme_bw() +
  geom_hline(yintercept = -log2(0.05), col = "red", linetype = "dashed") +
  geom_text_repel() +
  ylab("-log2(p-value)") +
  xlab("Log Odds of LTBI") +
  geom_text(aes(x = -8.4, y = 4.45 ,label = "p = 0.05", col = "red")) +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(-8.44, 8))
logit_graph 


#Make table of logistic regression results
library(kableExtra)

logit_table <- logit_pval_data %>%
  arrange(p_val) %>%
  select("feature", "p_val", "coeff", "fdr") %>%
  filter(p_val < 0.05)

logit_table_2 <- logit_table[, c("feature", "coeff", "p_val", "fdr")]
colnames(logit_table_2) <- c("Antibody Feature", "Logistic Regression Coefficient", "p value", "fdr value")

kable(logit_table_2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")
```






Final Analysis



In short, the results found herein are consistent with previously published data which reveal that LTBI and ATB individuals exhibit remarkably distinct antibody profiles (Lu et al. Cell 2016.). Most notably, here I find that individuals with ATB display a pro-inflammatory antibody glycosylation signature. This glycosylation signature -- lack of galactosylation and sialylation -- is reminiscent of that observed in many autoimmune diseases, as well as the chronic infectious diseases of HIV and viral hepatitis. Interestingly, in these other contexts, data suggest that these antibody glycosylation patterns may have diagnostic or even prognostic potential. Thus, the finding that this pattern is stronger in ATB as compared to LTBI individuals points to the diagnostic potential of this finding for resolving ATB from LTBI.  






